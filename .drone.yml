# å£°æ˜è¿™æ˜¯ä¸€ä¸ªDroneæµæ°´çº¿é…ç½®
kind: pipeline
# ä½¿ç”¨Dockeræ‰§è¡Œå™¨è¿è¡Œæµæ°´çº¿
type: docker
# æµæ°´çº¿æ˜¾ç¤ºåç§°ï¼ˆåœ¨Webç•Œé¢æ˜¾ç¤ºï¼‰
name: skr-oa
clone:  
  # å…‹éš†åˆ†æ”¯
  branch: master
  # é»˜è®¤è·¯å¾„
  path: /drone/src
# å…¨å±€ç¯å¢ƒå˜é‡
environment:
  WORKSPACE: /drone/src  # Droneé»˜è®¤å…‹éš†è·¯å¾„
steps:
  # æ„å»ºé˜¶æ®µå¼€å§‹
  - name: build  #ğŸŒŸæ­¥éª¤åç§°ï¼ˆæ§åˆ¶å°å¯è§ï¼‰
    image: node:18  #ğŸŒŸæŒ‡å®šç²¾ç¡®Nodeç‰ˆæœ¬
    commands:  #ğŸŒŸè¦æ‰§è¡Œçš„å‘½ä»¤åˆ—è¡¨
      - npm install --force  # å¼ºåˆ¶å®‰è£…ä¾èµ–ï¼ˆè§£å†³peerä¾èµ–é—®é¢˜ï¼‰
      - npm run build       # æ‰§è¡Œé¡¹ç›®æ„å»º
    volumes:  # æŒ‚è½½å·é…ç½®
      - name: node-cache  # å¼•ç”¨å·²å®šä¹‰çš„å·
        path: /drone/src/node_modules  # æŒ‚è½½åˆ°å®¹å™¨å†…çš„è·¯å¾„

  # dockeré˜¶æ®µ
  - name: publish-image
    image: plugins/docker
    volumes:
    - name: var-run
      path: /var/run/
    settings:
      daemon_off: true
      purge: false
      repo: 49.233.17.230:8000/frontend/${DRONE_REPO_NAME}
      config:
        from_secret: HARBOR_AUTH_CONFIG
      insecure: true
      tag:
        - latest
        - ${DRONE_COMMIT}.${DRONE_BUILD_NUMBER}
      dockerfile: ./Dockerfile
    when:
      branch:
        - dev
        - test
        - master
        - entry-rules
    

  # # éƒ¨ç½²é˜¶æ®µå¼€å§‹
  - name: to-nginx
    image: docker:cli  #ğŸŒŸåŒ…å«dockerå‘½ä»¤çš„å®˜æ–¹é•œåƒ
    depends_on: [build]  #ğŸŒŸç¡®ä¿åœ¨æ„å»ºå®Œæˆåæ‰§è¡Œ
    volumes:
      - name: docker-sock  #ğŸŒŸå…³é”®é…ç½®ï¼šæŒ‚è½½Dockerå¥—æ¥å­—
        path: /var/run/docker.sock  # å®¹å™¨å†…Dockerè¿æ¥è·¯å¾„
    commands:
      - docker cp /drone/src/dist nginx:/usr/share/nginx/html/  #ğŸŒŸå¤åˆ¶æ„å»ºäº§ç‰©

volumes:  #ğŸŒŸå…¨å±€å·å®šä¹‰
  - name: node-cache
    host:   # å®¿ä¸»æœºç›®å½•
      path: /root/docker/drone/drone-data/node-cache/skr-oa # å­˜å‚¨é¡¹ç›®ä¾èµ–æ–‡ä»¶ï¼Œä¸‹æ¬¡æ„å»ºä¼šå¿«ä¸€ç‚¹
  - name: docker-sock
    host:  #ğŸŒŸæ˜ å°„å®¿ä¸»æœºè·¯å¾„
      path: /var/run/docker.sock  # å®¿ä¸»æœºDockerå¥—æ¥å­—ä½ç½®
